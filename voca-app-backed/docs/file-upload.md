# Express æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å®ç°æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·å¤´åƒä¸Šä¼ åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ–‡ä»¶ä¸Šä¼ ã€å­˜å‚¨ã€éªŒè¯å’ŒURLç”Ÿæˆç­‰åŠŸèƒ½ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶ (`src/middleware/upload.js`)

**æ ¸å¿ƒåŠŸèƒ½**:
- æ–‡ä»¶ç±»å‹éªŒè¯ (åªå…è®¸å›¾ç‰‡æ ¼å¼)
- æ–‡ä»¶å¤§å°é™åˆ¶ (2MB)
- æ–‡ä»¶å‘½åè§„åˆ™ (ç”¨æˆ·ID_æ—¶é—´æˆ³_UUID)
- å­˜å‚¨ç›®å½•ç®¡ç†
- å®‰å…¨éªŒè¯

**æ”¯æŒçš„æ–‡ä»¶ç±»å‹**:
- JPEG (image/jpeg, image/jpg)
- PNG (image/png)
- GIF (image/gif)
- WebP (image/webp)

**æ–‡ä»¶å‘½åè§„åˆ™**:
```
{userId}_{timestamp}_{uuid}.{extension}
ä¾‹å¦‚: 1_1763291522732_2bc1fe01.png
```

### 2. æ§åˆ¶å™¨ (`src/controller/userController.js`)

**ä¸Šä¼ æµç¨‹**:
1. éªŒè¯ç”¨æˆ·è®¤è¯çŠ¶æ€
2. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
3. è®°å½•æ–‡ä»¶ä¿¡æ¯
4. ç”Ÿæˆè®¿é—®URL
5. è°ƒç”¨Serviceå±‚æ›´æ–°æ•°æ®åº“
6. è¿”å›å“åº”ç»“æœ

### 3. æœåŠ¡å±‚ (`src/service/userService.js`)

**æ ¸å¿ƒæ–¹æ³•**:
- `updateUserAvatar()`: æ›´æ–°ç”¨æˆ·å¤´åƒURL
- `deleteOldAvatarFile()`: åˆ é™¤æ—§å¤´åƒæ–‡ä»¶
- è‡ªåŠ¨æ¸…ç†åŠŸèƒ½ï¼Œé¿å…ç£ç›˜ç©ºé—´æµªè´¹

### 4. è·¯ç”±é…ç½® (`src/routes/user.js`)

**ä¸Šä¼ ç«¯ç‚¹**:
```
POST /api/user/avatar
è®¤è¯è¦æ±‚: Bearer Token
æ–‡ä»¶å­—æ®µ: avatar
```

## ğŸ”§ æŠ€æœ¯å®ç°

### ä¾èµ–åŒ…
```json
{
  "multer": "^1.4.5",      // æ–‡ä»¶ä¸Šä¼ ä¸­é—´ä»¶
  "uuid": "^9.0.0"         // å”¯ä¸€IDç”Ÿæˆ
}
```

### ç›®å½•ç»“æ„
```
uploads/
â””â”€â”€ avatars/              # å¤´åƒå­˜å‚¨ç›®å½•
    â”œâ”€â”€ 1_1666999900_abc12345.jpg
    â”œâ”€â”€ 2_1666999910_def67890.png
    â””â”€â”€ ...
```

### é™æ€æ–‡ä»¶æœåŠ¡
```javascript
app.use('/uploads', express.static('uploads'))
```

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### 1. æ–‡ä»¶ç±»å‹éªŒè¯
- MIMEç±»å‹æ£€æŸ¥
- æ–‡ä»¶å¤´ç­¾åéªŒè¯
- é˜²æ­¢æ¶æ„æ–‡ä»¶ä¸Šä¼ 

### 2. æ–‡ä»¶å¤§å°é™åˆ¶
- æœ€å¤§æ–‡ä»¶å¤§å°: 2MB
- è‡ªåŠ¨æ‹’ç»è¶…å¤§æ–‡ä»¶

### 3. ç”¨æˆ·è®¤è¯
- éœ€è¦æœ‰æ•ˆçš„JWT Token
- åªå…è®¸ç”¨æˆ·ä¸Šä¼ è‡ªå·±çš„å¤´åƒ

### 4. æ–‡ä»¶åå®‰å…¨
- ä½¿ç”¨UUIDé¿å…æ–‡ä»¶åå†²çª
- é˜²æ­¢è·¯å¾„éå†æ”»å‡»

## ğŸ“ API ä½¿ç”¨ç¤ºä¾‹

### ä¸Šä¼ å¤´åƒ
```bash
curl -X POST http://localhost:3000/api/user/avatar \
  -H "Authorization: Bearer {token}" \
  -F "avatar=@/path/to/avatar.jpg"
```

**æˆåŠŸå“åº”**:
```json
{
  "code": 200,
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ",
  "data": {
    "userId": 1,
    "userAvatar": "http://localhost:3000/uploads/avatars/1_1666999900_abc12345.jpg"
  },
  "timestamp": "2025-11-16T11:12:02.762Z"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "code": 400,
  "message": "æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2MB",
  "data": null
}
```

## ğŸ”„ å·¥ä½œæµç¨‹

1. **ç”¨æˆ·é€‰æ‹©æ–‡ä»¶**
2. **å‰ç«¯å‘é€POSTè¯·æ±‚**åˆ° `/api/user/avatar`
3. **è®¤è¯ä¸­é—´ä»¶**éªŒè¯JWT Token
4. **ä¸Šä¼ ä¸­é—´ä»¶**éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
5. **æ–‡ä»¶ä¿å­˜**åˆ° `uploads/avatars/` ç›®å½•
6. **æ§åˆ¶å™¨**ç”Ÿæˆæ–‡ä»¶URL
7. **æœåŠ¡å±‚**æ›´æ–°æ•°æ®åº“è®°å½•
8. **åˆ é™¤æ—§æ–‡ä»¶** (å¯é€‰)
9. **è¿”å›å“åº”**åŒ…å«æ–‡ä»¶URL

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### 1. æ­£å¸¸ä¸Šä¼ æµ‹è¯•
```bash
# ä½¿ç”¨æœ‰æ•ˆtokenä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
curl -X POST http://localhost:3000/api/user/avatar \
  -H "Authorization: Bearer valid_token" \
  -F "avatar=@test.png"
```

### 2. æ–‡ä»¶ç±»å‹éªŒè¯
```bash
# å°è¯•ä¸Šä¼ éå›¾ç‰‡æ–‡ä»¶
curl -X POST http://localhost:3000/api/user/avatar \
  -H "Authorization: Bearer valid_token" \
  -F "avatar=@test.txt"
```

### 3. æ–‡ä»¶å¤§å°é™åˆ¶æµ‹è¯•
```bash
# å°è¯•ä¸Šä¼ è¶…å¤§æ–‡ä»¶
curl -X POST http://localhost:3000/api/user/avatar \
  -H "Authorization: Bearer valid_token" \
  -F "avatar=@large_image.jpg"
```

### 4. è®¤è¯æµ‹è¯•
```bash
# æ— tokenä¸Šä¼ 
curl -X POST http://localhost:3000/api/user/avatar \
  -F "avatar=@test.png"
```

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

### 1. æ–‡ä»¶å­˜å‚¨
- ç¡®ä¿æœåŠ¡å™¨æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
- è€ƒè™‘ä½¿ç”¨äº‘å­˜å‚¨æœåŠ¡ (å¦‚AWS S3ã€é˜¿é‡Œäº‘OSS)
- å®šæœŸæ¸…ç†æ— æ•ˆæ–‡ä»¶

### 2. å®‰å…¨é…ç½®
- é™åˆ¶ä¸Šä¼ æ–‡ä»¶å¤§å°
- é…ç½®åˆé€‚çš„CORSç­–ç•¥
- ç›‘æ§ä¸Šä¼ æ—¥å¿—

### 3. æ€§èƒ½ä¼˜åŒ–
- è€ƒè™‘ä½¿ç”¨CDNåŠ é€Ÿé™æ€æ–‡ä»¶è®¿é—®
- å®ç°å›¾ç‰‡å‹ç¼©åŠŸèƒ½
- æ·»åŠ æ–‡ä»¶ç¼“å­˜ç­–ç•¥

## ğŸ”® æ‰©å±•åŠŸèƒ½å»ºè®®

1. **å›¾ç‰‡å¤„ç†**: è‡ªåŠ¨å‹ç¼©ã€è£å‰ªã€æ ¼å¼è½¬æ¢
2. **å¤šæ–‡ä»¶ä¸Šä¼ **: æ”¯æŒæ‰¹é‡ä¸Šä¼ 
3. **äº‘å­˜å‚¨é›†æˆ**: é›†æˆAWS S3ã€é˜¿é‡Œäº‘OSSç­‰
4. **å›¾ç‰‡å®¡æ ¸**: AIè‡ªåŠ¨å®¡æ ¸å›¾ç‰‡å†…å®¹
5. **ä¸Šä¼ è¿›åº¦**: WebSocketå®æ—¶è¿›åº¦æ¨é€

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

- ä¸Šä¼ æˆåŠŸç‡
- å¹³å‡ä¸Šä¼ æ—¶é—´
- å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
- é”™è¯¯ç±»å‹ç»Ÿè®¡

---

**å®ç°æ—¥æœŸ**: 2025-11-16
**ç‰ˆæœ¬**: 1.0.0
**ä½œè€…**: Vocaå¼€å‘å›¢é˜Ÿ