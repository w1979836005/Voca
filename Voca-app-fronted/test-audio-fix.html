<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘æ’­æ”¾ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .test-item {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            margin-left: 10px;
            color: #666;
        }
        .word-info {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .audio-url {
            font-size: 12px;
            color: #888;
            word-break: break-all;
            margin: 5px 0;
        }
        .debug-log {
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>éŸ³é¢‘æ’­æ”¾ä¿®å¤æµ‹è¯•</h1>
    <p>æµ‹è¯•ä¿®å¤åçš„éŸ³é¢‘æ’­æ”¾é€»è¾‘ï¼Œé˜²æ­¢é‡å¤æ’­æ”¾</p>

    <div class="debug-log" id="debug-log">
        è°ƒè¯•æ—¥å¿—ï¼š<br>
    </div>

    <div id="test-results">
        <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
    </div>

    <script>
        let isPlaying = false; // æ¨¡æ‹Ÿæ’­æ”¾çŠ¶æ€

        // æ—¥å¿—è¾“å‡º
        function log(message) {
            const logDiv = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æµ‹è¯•éŸ³é¢‘æ’­æ”¾
        async function testAudioPlay() {
            const resultsDiv = document.getElementById('test-results');

            try {
                log('å¼€å§‹è·å–è¯å•æ•°æ®...');

                // è·å–è¯å•å•è¯æ•°æ®
                const response = await fetch('http://localhost:3000/api/wordlist/1/words?page=1&limit=3');
                const data = await response.json();

                if (data.code !== 200) {
                    log('âŒ è·å–æ•°æ®å¤±è´¥: ' + data.message);
                    resultsDiv.innerHTML = `<p style="color: red;">è·å–æ•°æ®å¤±è´¥: ${data.message}</p>`;
                    return;
                }

                log(`âœ… æˆåŠŸè·å–æ•°æ®ï¼Œå…±${data.data.words.length}ä¸ªå•è¯`);
                let html = '<h2>æµ‹è¯•ç»“æœ (ä¿®å¤å):</h2>';

                data.data.words.forEach((word, index) => {
                    html += `
                        <div class="test-item">
                            <div class="word-info">${index + 1}. ${word.word} ${word.pronunciation || ''}</div>
                            <div class="audio-url">éŸ³é¢‘URL: ${word.audioUrl || 'æ— '}</div>
                            <button id="btn-${index}" onclick="testPlayAudio('${word.audioUrl}', '${word.word}', ${index})">æµ‹è¯•æ’­æ”¾</button>
                            <button onclick="testTTS('${word.word}')">æµ‹è¯•TTS</button>
                            <span class="status" id="status-${index}">ç­‰å¾…æµ‹è¯•</span>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = html;
                log('âœ… æµ‹è¯•ç•Œé¢æ¸²æŸ“å®Œæˆ');

            } catch (error) {
                log('âŒ æµ‹è¯•å¤±è´¥: ' + error.message);
                resultsDiv.innerHTML = `<p style="color: red;">æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        }

        // ä¿®å¤åçš„éŸ³é¢‘æ’­æ”¾å‡½æ•°
        function testPlayAudio(audioUrl, word, index) {
            const statusSpan = document.getElementById(`status-${index}`);
            const button = document.getElementById(`btn-${index}`);

            log(`ğŸ”Š ç‚¹å‡»æ’­æ”¾: ${word}`);

            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (isPlaying) {
                log('âš ï¸ æ­£åœ¨æ’­æ”¾ä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
                statusSpan.textContent = 'âš ï¸ æ­£åœ¨æ’­æ”¾ä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»';
                return;
            }

            if (!audioUrl || audioUrl.trim() === '') {
                log(`â„¹ï¸ ${word} æ— éŸ³é¢‘URLï¼Œä½¿ç”¨TTS`);
                statusSpan.textContent = 'â„¹ï¸ æ— éŸ³é¢‘URLï¼Œä½¿ç”¨TTS';
                testTTS(word);
                return;
            }

            // è®¾ç½®æ’­æ”¾çŠ¶æ€
            isPlaying = true;
            button.disabled = true;
            button.textContent = 'æ’­æ”¾ä¸­...';
            statusSpan.textContent = 'ğŸ”„ æ­£åœ¨åŠ è½½éŸ³é¢‘...';

            log(`ğŸµ å¼€å§‹æ’­æ”¾éŸ³é¢‘: ${word}`);

            try {
                const audio = new Audio(audioUrl);
                let hasStarted = false;

                audio.addEventListener('canplay', () => {
                    log('âœ… éŸ³é¢‘å¯ä»¥æ’­æ”¾');
                    if (!hasStarted) {
                        hasStarted = true;
                        audio.play();
                    }
                });

                audio.addEventListener('play', () => {
                    log('ğŸ”Š å¼€å§‹æ’­æ”¾ ' + word);
                    statusSpan.textContent = 'ğŸ”Š æ­£åœ¨æ’­æ”¾ ' + word;
                });

                audio.addEventListener('ended', () => {
                    log('âœ… æ’­æ”¾å®Œæˆ');
                    isPlaying = false;
                    button.disabled = false;
                    button.textContent = 'æµ‹è¯•æ’­æ”¾';
                    statusSpan.textContent = 'âœ… æ’­æ”¾å®Œæˆ';
                });

                audio.addEventListener('error', (e) => {
                    log('âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥: ' + JSON.stringify(e));
                    isPlaying = false;
                    button.disabled = false;
                    button.textContent = 'æµ‹è¯•æ’­æ”¾';
                    statusSpan.textContent = 'âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œå°è¯•TTS';
                    testTTSDirect(word);
                });

                audio.addEventListener('pause', () => {
                    log('â¸ï¸ éŸ³é¢‘æš‚åœ');
                });

                // è®¾ç½®è¶…æ—¶
                const timeout = setTimeout(() => {
                    log('â° æ’­æ”¾è¶…æ—¶');
                    isPlaying = false;
                    button.disabled = false;
                    button.textContent = 'æµ‹è¯•æ’­æ”¾';
                    statusSpan.textContent = 'â° æ’­æ”¾è¶…æ—¶';
                    audio.pause();
                }, 10000);

                audio.addEventListener('ended', () => {
                    clearTimeout(timeout);
                });

                audio.addEventListener('error', () => {
                    clearTimeout(timeout);
                });

                audio.load();

            } catch (error) {
                log('âŒ éŸ³é¢‘æ’­æ”¾å¼‚å¸¸: ' + error.message);
                isPlaying = false;
                button.disabled = false;
                button.textContent = 'æµ‹è¯•æ’­æ”¾';
                statusSpan.textContent = 'âŒ éŸ³é¢‘æ’­æ”¾å¼‚å¸¸ï¼Œå°è¯•TTS';
                testTTSDirect(word);
            }
        }

        // ç›´æ¥æµ‹è¯•TTS
        function testTTS(word) {
            testTTSDirect(word);
        }

        function testTTSDirect(word) {
            log(`ğŸ—£ï¸ ä½¿ç”¨TTSæ’­æ”¾: ${word}`);

            if ('speechSynthesis' in window) {
                try {
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.8;

                    utterance.onstart = () => {
                        log('ğŸ”Š TTSå¼€å§‹æ’­æ”¾ ' + word);
                    };

                    utterance.onend = () => {
                        log('âœ… TTSæ’­æ”¾å®Œæˆ');
                    };

                    utterance.onerror = (e) => {
                        log('âŒ TTSé”™è¯¯: ' + JSON.stringify(e));
                    };

                    window.speechSynthesis.speak(utterance);

                } catch (error) {
                    log('âŒ TTSå¼‚å¸¸: ' + error.message);
                }
            } else {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒTTS');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
            testAudioPlay();
        });
    </script>
</body>
</html>