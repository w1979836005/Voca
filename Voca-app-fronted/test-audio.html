<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘æ’­æ”¾æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .test-item {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            margin-left: 10px;
            color: #666;
        }
        .word-info {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .audio-url {
            font-size: 12px;
            color: #888;
            word-break: break-all;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>éŸ³é¢‘æ’­æ”¾æµ‹è¯•</h1>
    <p>æµ‹è¯•ä¸åŒç¯å¢ƒä¸‹çš„éŸ³é¢‘æ’­æ”¾åŠŸèƒ½</p>

    <div id="test-results">
        <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
    </div>

    <script>
        // æµ‹è¯•éŸ³é¢‘æ’­æ”¾
        async function testAudioPlay() {
            const resultsDiv = document.getElementById('test-results');

            try {
                // è·å–è¯å•å•è¯æ•°æ®
                const response = await fetch('http://localhost:3000/api/wordlist/1/words?page=1&limit=5');
                const data = await response.json();

                if (data.code !== 200) {
                    resultsDiv.innerHTML = `<p style="color: red;">è·å–æ•°æ®å¤±è´¥: ${data.message}</p>`;
                    return;
                }

                let html = '<h2>æµ‹è¯•ç»“æœ:</h2>';

                data.data.words.forEach((word, index) => {
                    html += `
                        <div class="test-item">
                            <div class="word-info">${index + 1}. ${word.word} ${word.pronunciation || ''}</div>
                            <div class="audio-url">éŸ³é¢‘URL: ${word.audioUrl || 'æ— '}</div>
                            <button onclick="testPlayAudio('${word.audioUrl}', '${word.word}')">æµ‹è¯•æ’­æ”¾</button>
                            <button onclick="testTTS('${word.word}')">æµ‹è¯•TTS</button>
                            <span class="status" id="status-${index}"></span>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æµ‹è¯•éŸ³é¢‘æ’­æ”¾
        function testPlayAudio(audioUrl, word) {
            const statusSpan = document.querySelector(`[onclick*="${word}"]`).nextElementSibling.nextElementSibling;

            if (!audioUrl || audioUrl.trim() === '') {
                statusSpan.textContent = 'âŒ æ— éŸ³é¢‘URLï¼Œä½¿ç”¨TTS';
                testTTS(word);
                return;
            }

            statusSpan.textContent = 'ğŸ”„ æ­£åœ¨åŠ è½½éŸ³é¢‘...';

            try {
                const audio = new Audio(audioUrl);

                audio.addEventListener('canplay', () => {
                    statusSpan.textContent = 'âœ… éŸ³é¢‘å¯ä»¥æ’­æ”¾ï¼Œæ­£åœ¨æ’­æ”¾...';
                    audio.play();
                });

                audio.addEventListener('play', () => {
                    statusSpan.textContent = 'ğŸ”Š æ­£åœ¨æ’­æ”¾ ' + word;
                });

                audio.addEventListener('ended', () => {
                    statusSpan.textContent = 'âœ… æ’­æ”¾å®Œæˆ';
                });

                audio.addEventListener('error', (e) => {
                    console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
                    statusSpan.textContent = 'âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œå°è¯•TTS';
                    testTTSDirect(word);
                });

                audio.load();

            } catch (error) {
                console.error('éŸ³é¢‘æ’­æ”¾å¼‚å¸¸:', error);
                statusSpan.textContent = 'âŒ éŸ³é¢‘æ’­æ”¾å¼‚å¸¸ï¼Œå°è¯•TTS';
                testTTSDirect(word);
            }
        }

        // ç›´æ¥æµ‹è¯•TTS
        function testTTS(word) {
            const statusSpan = document.querySelector(`[onclick*="${word}"]`).nextElementSibling.nextElementSibling;
            testTTSDirect(word, statusSpan);
        }

        function testTTSDirect(word, statusSpan) {
            if (!statusSpan) {
                const buttons = document.querySelectorAll('button');
                buttons.forEach(btn => {
                    if (btn.textContent.includes('æµ‹è¯•TTS') && btn.onclick && btn.onclick.toString().includes(word)) {
                        statusSpan = btn.nextElementSibling;
                    }
                });
            }

            if ('speechSynthesis' in window) {
                try {
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.8;

                    utterance.onstart = () => {
                        if (statusSpan) statusSpan.textContent = 'ğŸ”Š ä½¿ç”¨TTSæ’­æ”¾ ' + word;
                    };

                    utterance.onend = () => {
                        if (statusSpan) statusSpan.textContent = 'âœ… TTSæ’­æ”¾å®Œæˆ';
                    };

                    utterance.onerror = (e) => {
                        console.error('TTSé”™è¯¯:', e);
                        if (statusSpan) statusSpan.textContent = 'âŒ TTSæ’­æ”¾å¤±è´¥';
                    };

                    window.speechSynthesis.speak(utterance);

                } catch (error) {
                    console.error('TTSå¼‚å¸¸:', error);
                    if (statusSpan) statusSpan.textContent = 'âŒ TTSæ’­æ”¾å¼‚å¸¸';
                }
            } else {
                if (statusSpan) statusSpan.textContent = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒTTS';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', testAudioPlay);
    </script>
</body>
</html>